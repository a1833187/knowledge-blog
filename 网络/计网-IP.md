# IP

## IP基础知识

### IP介绍

网络层的作用是实现点到点的通信,也就是主机与主机之间的通信.

网络层(IP)和数据链路层(MAC)之间的关系就相当于行程表和具体的车票之间的关系.IP负责远程定位源IP地址和目标IP地址,而MAC负责两个直连设备之间的传输. 在整个传输过程中,源IP和目的IP是不发生改变的,发生改变的是源MAC和目的MAC.

### IP地址介绍

#### IP地址分类

> 1. A类地址![1660702219177](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1660702219177.png)
>
>    最大主机数等于主机号上的最大主机数-2,之所以-2是因为要去掉全1和全0的主机号.全1用于指定某个网络下所有主机,适用于广播,全0指定某个网络.
>
> 2. B类地址
>
>    ![1660702234119](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1660702234119.png)
>
> 3. C类地址
>
>    ![1660702241816](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1660702241816.png)
>
> 4. D类地址
>
>    ![1660702248159](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1660702248159.png)
>
> 5. E类地址
>
>    ![1660702254948](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1660702254948.png)
>
>    单播,广播,组播(多播)的区别
>
>    > 单播是指发送端发送的数据包发送给特定的单个接收端
>    >
>    > 广播是指发送端将数据包发送给同一个网络下的其他主机,但并不能通过路由器将数据包发送到别的网络中.
>    >
>    > 组播是指发送端发送的数据包既可以发送个同一个网络下的其他主机,也可以通过路由器将数据包发送给其他网络中的主机.
>
>    IP分类的优缺点
>
>    > 优点:可以根据首位是0还是1来精确一个IP地址是哪种类型.从而可以快速的找到网络地址和主机地址
>    >
>    > 缺点
>    >
>    > > 1. 同一个网络下没有地址层次,缺少地址的灵活性.
>    > > 2. A,B,C类地址的最大主机数量不合适,C类太少,B类太多.

#### 无地址分类CIDR

表现形式为a.b.c.d/x,x表示前x位是网络号.

子网掩码与IP地址按位与得到的结果就是网络号.子网掩码还可以作子网划分:将主机地址分成两部分:子网网络地址和子网主机地址.子网网络地址的位上为1.

#### 公有与私有IP地址

私有IP地址的分类:10.0.0.0~10.255.255.255,172.16.0.0~172.31.255.255,192.168.0.0~192.168.255.255.同一个网络中的IP地址可以由网管人员自己分配,但要保证局域网内唯一.但在不同的局域网中,私有IP地址可以相同.

#### IP地址与路由控制

IP地址的网络地址部分用于路由控制.在每个主机或路由器上都会存在一张路由控制表,其中每个记录是一个键值对,key是目的IP地址,value是下一跳的IP地址.当路由控制表中存在多条匹配记录时,按照key最长匹配机制(和目的IP地址相同位数最多的)选取下一跳的设备

有一个特殊的IP地址:环回IP地址:127.0.0.1/localhost,**该地址传输的数据包不会流向网络**

#### IP分片与重组

IP数据包会根据数据链路的MTU的大小进行分片,重组工作只能由目标主机进行,中转的路由器不能实现分片工作.因此在传输过程中,当某个分片丢失后,整个IP数据包作废.因此TCP才会在传输层进行分段.

### 相关IP协议

#### DNS

DNS负责域名解析.域名服务器是一个树状结构.在DNS解析域名的过程中,会从叶子节点向根节点一层一层找,然后在从根节点想另外一个叶子节点的方向一层一层的找.

#### ARP

ARP协议可以得到下一跳设备的MAC地址.根据IP地址得到对应的MAC地址.

在同一个链路中,主机广播发送ARP请求,请求中包含希望得到对应MAC地址的IP地址;同一个链路中的设备收到请求后会查看IP地址是否是自己的IP地址,如果是就将自己的MAC地址打包到ARP响应中发送给发送端.

当然,为了减少ARP广播的次数,操作系统会在本地缓存ARP表(IP-MAC).

除了ARP协议外,还要RARP协议,RARP协议是根据MAC地址得到IP地址.

通常会有一台RARP服务器中记录MAC地址对应的IP地址,当一些小型设备嵌入到网络中可以将自己的MAC地址发送给RARP服务器后得到自己的IP地址.

#### DHCP

DHCP可以动态的获取IP地址

流程

1. DHCP客户端首先用255.255.255.255作为UDP广播地址,并用0.0.0.0作为源IP地址广播发送DHCP请求包
2. DHCP服务器接收到请求包后会将可租赁的IP地址以及相关信息同样用255.255.255.255地址发送给DHCP客户端.
3. DHCP客户端接收到响应包后会从中选择一个服务器,并向DHCP服务器发送请求,回显配置的参数
4. DHCP服务器接受到请求后会返回DHCP ACK报文应答所要求的参数.

因为DHCP的发送形式是广播,只能实现在同一个网络中获取IP地址.为了实现不同网络获取IP地址,引入了DHCP中继代理,DHCP客户端将请求发送给DHCP中继代理,DHCP中继代理将请求单播给DHCP服务器.

#### NAT

NAT是为了解决IPv4地址总数不够用的一种方案.

NAT将同一个局域网中的设备的地址管理为私有IP,在访问其他网络的设备时,需要通过NAT将私有IP转为相同的公有IP地址,同时为了区分一个局域网中不同设备使用相同的端口号建立连接,NAT会将相同的端口号进行区分并将区分结果缓存到NART表中.

NAT的缺点:外部不能直接访问内部设备.

解决办法:IPv6    NAT穿透技术

#### ICMP

ICMP被称为互联网控制报文协议,负责确认IP包是否成功到达对端(IP协议本身是不可靠的),报告发送过程中IP包丢失的原因和改善网络设置等

当在传输过程中因为异常原因导致网络包丢失后,ICMP会以IP形式将报错信息原路返回给发送端.

#### IGMP

IGMP是因特网管理协议,主要负责管理组播的成员.路由可以通过IGMP加入到组播成员中.

## ping的工作原理

ping命令用于诊断通信网络是否畅通,是基于ICMP协议工作的.

ICMP是一种网络层协议,是对IP协议不可靠的一种补充机制,主要负责确认IP包是否到达对方,报告传输过程中数据包被丢弃的原因以及改善网络环境.

ICMP包头的类型有两种:查询报文类型,差错报文类型

> 查询报文类型
>
> 回送消息:0或8,用于确认消息是否正确被对方接收.ping命令就是基于回送消息实现的.0代表回送应答,8代表回送请求,当接收方返回正确的回送应答说明数据包被接收方成功接收.
>
> 差错报文类型
>
> > 目标不可达消息 ----3
> >
> > > 网络不可达 -- 0
> > >
> > > 主机不可达 -- 1
> > >
> > > 协议不可达 -- 2
> > >
> > > 端口不可达 -- 3
> > >
> > > 需要进行分片但设置是不分片 -- 4
> >
> > 原点抑制消息 ----4
> >
> > 重定向消息 ----5
> >
> > > 路由器发现发送端选择的不是最优路线则会触发重定向
> >
> > 超时消息 ----11
> >
> > > TTL减为0还没有到达对端说明超时

ping——查询报文类型的使用

主机A向主机B发送ping命令时,会发送ICMP回送请求给主机B,主机B在接收到请求报文确认无误后会发送ICMP回送应答给主机A,当主机A在规定的时间内接收到回送应答后可以得到发送的时间延迟,否则说明目标不可达.

ping命令利用的是ICMP回送类型中的回送请求和回送应答.

traceroute——差错报文类型的使用

traceroute的作用

> 1. 设置特殊的TTL来跟踪发送过程中途径的路由器
> 2. 设置不分片从而确定MTU的大小