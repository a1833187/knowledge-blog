# 网络

1. IP地址: 主机在Internet上的位置.
2. 端口号:一台主机上的某个软件的代号
3. 
   1. 协议:进行有效通信的前提就是明确通信的协议. 网络通信的本质传输的是光信号和电信号.通过光信号的频率(高频率/低频率)和电信号的电平(高电平/低电平)来表示0和1.
   2. 协议的好处:一个是不需要了解其它层协议的细节就可以完成对应的功能(封装),一个是同一层的协议之间可以换成其他的协议(耦合性低)
   3. OSI七层网络模型:应用层,表示层,会话层,传输层,网络层,数据链路层,物理层.

## 网络的构成要素

1. 通信媒介与数据链路

   计算机之间通过电缆相互连接,电缆有很多种,包括双绞线电缆,光纤电缆等等.常见的数据链路名有:以太网,无线,ATM,FDDI等.

   传输速率(带宽):数据传输的过程中两个设备之间数据流动的物理速度.衡量传输速率的是单位时间内数据量传输的多少,而不是传输的快慢.因为一班情况下各种传输媒介的流动速度是恒定的.

   吞吐量:除了衡量带宽,也衡量CPU的处理能力,网络的拥堵程度,报文中数据字段占有的长度等等.

2. 网卡:别名:网络接口卡(NIC),网络适配器,LAN卡等.一台计算机连接网络必须用到设备.属于OSI模型中的物理层.

3. 中继器:属于OSI模型的物理层.在物理层面上延长网络的设备.由电缆传输过来的光电信号经由中继器将减弱的信号进行放大然后传输给另外一个电缆.

   中继器的特点

   1. 能将电缆中传输的减弱的光电信号进行还原.
   2. 中继器两端连接的电缆的传输速率一般情况下是相同的.
   3. 即使数据在数据链路层发生了损坏中继器仍然会发送.

   含有多个端口的中继器叫集线器

4. 网桥/2层交换机:是在OSI模型的第2层——数据链路层面上连接两个网络的设备.能够识别数据链路层中的数据帧,并将这些数据帧临时存储于内存,再重新生成一个信号作为一个全新的帧传递给相连的另一个网段.

   网桥的特点

   1. 网桥没有连接网段个数的限制
   2. 网桥基本上只用于连接相同类型的网路,但有时也可以连接传输速率不同的网络(能够实现这个功能是因为网桥可以将数据帧临时存储起来)
   3. 在数据帧中有一个数据位叫FCS用以校验数据是否正确发送到目的地.网桥可以通过检查FCS中的值来判断数据是否完整,完整则发送,数据损坏则丢弃.
   4. 网桥可以通过地址自学功能和过滤功能来控制网络流量.这里的地址指的是物理地址MAC地址(可以唯一识别一台设备).某些网桥可以通过记住曾经通过自己转发的所有数据帧的MAC地址,并保存到自己的内存表中.

5. 路由器/3层交换机:是在OSI模型的第3层——网络层面上连接两个网络并对分组报文进行转发的设备.网络层的地址即为IP地址.

   路由器的特点:

   1. 可以将分组报文发送给另一个目标路由器地址.
   2. 可以连接不同的数据链路
   3. 可以分担网络负荷
   4. 一些路由器还具有网络安全功能.

6. 4-7层交换机:负责处理OSI模型中传输层至应用层数据的设备.常见的4-7层交换机有负载均衡器.当前端需求量比较大时,可以通过负载均衡器将前端的请求分担至不同的服务器上.

   特点:

   1. 可以分担高并发请求的压力
   2. 可以控制带宽:优先处理及时性比较高的请求(语音),放缓处理及时性比较低的请求(邮件)

7. 网关:是OSI模型中负责将从传输层至应用层的数据进行转换和转发的设备.网关可以将两个不能直接通信的协议进行转换从而实现通信的功能.比如互联网邮件和手机邮件之间的转换服务.由于其表示层和应用层面上的"电子邮件协议"不同.邮件网关可以将两种不同的协议进行转换.常见的其他网关有代理服务器,防火墙.代理服务器可以让客户端与服务器之间直接传输层至应用层对数据进行控制和处理.防火墙可以起到提高安全性的作用.

   代理服务器能够提高浏览速率的原因:代理服务器在安装时会自动开辟一块磁盘空间,磁盘空间内纪录了之前用户曾经访问过的Internet上的内容,当有其他用户再次访问相同的内容时,可以直接从缓存区传送给用户,而不是再一次在Internet上寻找

8. 虚拟化技术和云:在某些特殊的场景下,比如抽奖系统,双十一购物节,用户的请求量在一个较短的时间内会发生爆发式增长,而在这个时间段的前后的请求量则正常.为了应付高并发,多需求我们需要开放更多的服务器等接受请求并能够作出响应的物理设备.因此为每个网站和运行商提供固定的网络资源的做法是非常低效的.但频繁的切换实际的物理设备又不现实.利用虚拟化技术将物理设备虚拟化,通过软件去分配各种资源.利用虚拟化技术根据使用者动态调整必要资源的机制被人称作"云".

## TCP/IP基础知识

#### TCP/IP标准化

1. TCP/IP的具体含义:利用IP进行通信时所必须用到的协议群的统称.包括但不限于IP或ICMP,UDP或TCP,FTP或TELNET以及HTTP等.TCP/IP协议也被称为网络协议族.

2. TCP/IP的标准化的特点:开放性:TCP/IP协议是由IETF讨论制定的,而IETF本身是一个允许任何人加入进行讨论的组织.实用性:在TCP/IP的标准化过程中,制订某一协议的规范本身没有那么重要,而首要任务是实现真正能够应用TCP/IP的通信技术.

3. TCP/IP规范——RFC(Request for Comment):纪录了协议规范内容,协议实现和应用的相关信息FYI以及实验方面的信息Experimental

   RFC文档通过编号组织每个协议的标准化要求.RFC的编码是既定的,一旦确定不可修改.因此当某个RFC文档内的内容需要更新或扩展时,则需要一个全新的RFC编号.由于这种形式导致更改太过繁琐,人们采用了STD编号.STD表示哪个编号制订了哪个协议,因此同一个协议内的规范内容发生变化STD也不会发生变化.

4. TCP/IP的标准化流程:互联网草案阶段——提议标准阶段——草案标准阶段——标准阶段.互联网草案阶段的有效期只有6个月,在这个阶段,任何个体和组织都可以在互联网上撰写并发布自己的意见文档.经过充分的讨论,得到IESG的认可就会被写入RFC文档,进入提议标准阶段.在之后如果这个协议规范被众多设备应用且得到IESG的认可则进入草案标准阶段.从草案标准阶段到达标准阶段需要更多的设备实现并应用这个特定的协议并得到IESG的最终批准.与一般的标准化不同,TCP/IP中的某个协议的规范最终被确定下来后,它其实已经在众多设备上得到了普及.因此具有很强的实用性.

#### 互联网基础知识

1. 互联网:英文名为"The Internet".如今已经称为了一种专有名词,当特指网络之间的连接时,被译为"Internet",也叫网际网,指将多个网络连接使其构成一个更大的网络.与Internet对应的一种网络叫做Intranet,指用Internet技术将企业内部的组织机构连接起来形成一个企业范围内的封闭网络.

2. TCP/IP本身就是为使用互联网而开发的协议族,所以互联网的协议就是TCP/IP.

3. 互联网的结构:较小范围的网络之间相连 ===> 机构内部的网络相连 ===> 区域网络相连 ===> 互联网.

   互联网中的每个网络都是有骨干网和末端网组成,每个网络之间同过NOC相连.如果网络运营商不同,则需要通过IX来连接异构的网络.

4. ISP和区域网:连接互联网需要向ISP(Internet Service Provider)和区域网提出申请.一般情况下向ISP签约服务即可入网.区域网是特定区域内由团队或志愿者所运营的网络.

#### TCP/IP协议分层模型

1. 硬件(物理层):负责物理层面上的数据传输,如以太网,电话线路等等.硬件之间能够相互通信是TCP/IP协议存在的前提.

2. 网络接口层(数据链路层):利用以太网中的数据链路层进行通信.相当于是NIC(网卡)的"驱动程序".驱动程序是操作系统和硬件之间起桥梁作用的软件.计算机的一些外围附加设备和扩展卡突进需要物理硬件,还需要有相应驱动程序的支持.(常见的驱动程序一般在电脑上已经内置好了,所以可以即拔即插)

3. 互联网层(网络层):使用IP协议,IP协议基于IP地址转发分包数据.IP协议的作用是将分组数据包发送到目的主机.(忽略传输过程中的细节,只关注分组数据包发送到**目的主机**)

   1. IP:跨越网络传送数据包,使整个互联网都能收到数据的协议.通过IP地址识作为主机的标识.IP协议不具有重发机制,即使分组数据包未能达到对端主机也不会重发,因此,属于非可靠性传输协议.
   2. ICMP:IP数据包在发送途中反生异常导致无法传送到目的地址,需要给发送端发送一个发生异常的通知.ICMP有时也用来诊断网络健康的健康状况.
   3. ARP:从分组数据包中的IP地址里解析出MAC地址的协议.

4. 传输层:最主要的功能是让应用程序之间实现通信.通过端口号来分清计算机中程序和程序之间到底谁和谁在通信

   1. TCP:一种面向有连接的传输层协议.可以在传输过程中判断数据是否完整的发送到了对方,比较可靠.
   2. UDP:一种面向无连接的传输层协议.不可靠.检查数据包的完整性这件事需要在应用程序中实现.

5. 应用层(会话层以上的分层):浏览器与服务端之间通信所用的协议是HTTP,所传输的数据格式主要是HTML,HTTP属于OSI模型中应用层上的协议,HTML属于表示层上的协议. 

   应用层常见的协议:

   1. 电子邮件的协议:SMTP(Simple Mail Tranfer Protocol)
   2. 文件传输的协议:FTP(File Tranfer Protocol)
   3. 远程登录的协议:TELNET,SSH(Secure SHell)
   4. 网络管理的协议:SNMP(Simple Network Management Protocol), MIB(Management Information Base)

#### TCP/IP分层模型与通信事例

1. 数据包首部:每一层中包括每一层的首部和数据,其中首部指的是该层用到的协议的相关信息以及目的地址等必要信息.从下一层的角度来看,上一层的首部和数据即为该层的数据.

   ![1651408324856](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1651408324856.png)

2. 数据的单位:包,帧,数据报,段,消息:包是全能型术语,帧用于表示数据链路层数据包的单位,数据报是IP和UDP等网络层以上的分层中数据包的单位,段表示TCP数据流中的信息,消息是应用层中数据的单位.

3. 数据包的发送流程(以发送电子邮件为例):

   1. 应用程序:发送端建立邮件并指定收件人邮箱和邮件的内容,应用程序会对邮箱内容进行编码处理(相当于OSI模型中的表示层),编码转化后,邮箱不一定会立刻发送,对于某些邮箱而言,可能一次发送多条邮件,也可能需要接收方点击收信.也就是在合适的时刻建立连接(相当于OSI模型中的会话层)
   2. TCP模块:负责建立连接,发送数据和断开连接.在应用层数据的前端加上TCP首部,包括源端口号和目的端口号(用以识别发送主机和应用主机上的应用),序号(表示该包中某个数据分包是发送端整个数据包的第几字节的序列号)以及校验和(判断数据是否被损坏)
   3. IP模块的处理:将TCP中传过来的首部和数据当做该层的数据.并在TCP首部的前端加上IP首部,包含源IP地址和目的IP地址.IP首部之后还有用来判断是TCP还是UDP的信息.IP包生成后参考路由控制表决定接收该IP包的路由或主机.然后将该IP包发送给对应的驱动程序.如果不知道具体的MAC地址,则通过ARP协议查找目的端的MAC地址.
   4. 以太网驱动的处理:给IP包前端加上以太网包首部,包括源MAC地址和目的MAC地址以及标志以太网类型的以太网数据的协议.在整个包的最后加上FCS(冗余校验和),用以判断数据在传输过程中是否因为噪声而损害.
   5. 每个分层的包首部都会包含一个识别位用来识别上一层协议的种类信息.

## 数据链路

1. 数据链路的作用:数据链路层的协议决定了通信媒介互连的设备之间传输的规范.其主要作用是把数据帧转换为01字节流.具体技术包括:MAC寻址,介质共享,非公有网络,分组交换,环路检测,VLAN(虚拟局域网)

2. 网络拓扑:网络的连接和构成的形态,包括总线型,环形,星形,网状型等

3. MAC地址:用于识别数据链路中互连的节点.MAC地址有6个字节(48bit).任何一个网卡的MAC地址都是唯一的(事实上,MAC地址也不一定都不一样,但只要保证在同一个数据链路上MAC的地址唯一就不会出现问题.比如在自己电脑上开多个虚拟机时通过虚拟软件设定MAC地址给多个虚拟网卡时就很可能会出现MAC地址重复的现象.)![1651493935334](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1651493935334.png)

   第1位:单播地址(0),多播地址(1)         第2位:全局地址(0),本地地址(1)

   第3-24位:由IEEE管理并保证各厂家之间不重复       第25-48位:由厂商管理并保证产品之间不重复

4. 从通信介质的使用方法来看,网络可分为共享介质型和非共享介质型.

   1. 共享介质型网络指有多个设备共享一个通信介质的网络.共享介质型网络有两种介质访问控制方式:
      1. 争用方式(CSMA):令网络中的多个站(数据链路层中的节点)采用先到先得的方式占用信道.如果多个节点同时发送帧,则会发生冲突.因此产生了改进的CSMA/CD方式提前对每个站检查冲突.其工作原理:如果载波信道上没有数据波动,则任何站都可以发送数据.在发送数据的同时检测电压变化(检测数据冲突),如果电压发生异常,则会发送一个阻塞报文,放弃发送数据帧.之后在随机延时一段时间后进行重发.
      2. 令牌传递方式:沿着令牌环发送"令牌",获得"令牌"的站才可以发送数据.这种方式可以避免冲突,但在不冲突的情况下,信道的利用率也不会达到100%,因此产生了其他改进的令牌传递的技术,如:早期令牌释放,令牌追加以及多个令牌同时循环等等.

5. 非共享介质网络:不共享介质,对介质采取专用的一种传输控制方式.网络中的每个站直连交换机,由交换机负责转发数据帧.

6. 根据MAC地址进行转发.以太网交换机就是有多个端口的网桥.他们根据数据链路层中每个帧的目的MAC地址决定从哪个网络接口发送数据.这时所参考的用以记录发送接口的表叫做转发表.转发表的内容不需要手动录入,当数据链路层中的每个站接收到包时会将包中的源MAC地址以及曾经在其他包中该地址作为目的MAC地址的接口的对应关系记录到转发表中,这一过程叫做自学过程.

   举例:主机A通过端口1向主机B发送数据帧,转发表中会记录主机A和端口1的对应关系,因为不知晓主机B和哪个端口对应,所以采取"群发"的方式给该交换机上连接的其他所有主机;当主机B通过端口2向主机A发送数据帧时,转发表中会记录主机B和端口2的对应关系,因为已经知晓主机A和端口1对应,所以只把帧拷贝给端口1.至此,在之后主机A和主机B之间相互通信时就只在它们对应的端口内通信.

   由于MAC地址没有层次性(IP地址有层次性),当与交换机相连的设备的数量增加时,转发表也会变大,检索转发表的效率就会变低,因此,当连接多个终端时有必要将网络划分为多个数据链路(类似于网络层IP地址对地址的分层管理(A-a-1)).

   交换机有两种转发方式:存储转发:检查以太网数据帧末尾的FCS,当数据因为冲突或噪声而发横破坏时就不会再继续转发;直接转发:不需要将整个帧获取到再转发,只需要知道目的MAC地址就可以转发,延迟短但可能会发错误帧.

7. 环路检测技术:通过网桥连接网络时,可能会出现环路,最坏的情况下,数据帧会在环路中被持续转发,严重甚至会导致网络瘫痪.解决网络环路的方式:生成树法和源路由法.

   1. 生成树法:规定每个网桥必须在每1-10s内相互交换BPDU包,从而判断哪些端口可以正常使用,以便消除环路.一旦发生故障,立刻切换通信线路,利用那些没有被使用的端口继续进行传输.这种方式的弊端是一旦发生切换线路需要耗时几十秒(之后提出了RSTP方法将这个时间缩短到了几秒以内)
   2. 源路由法:该方式可以判断发送数据的源地址是通过哪个网桥实现传输的,并将帧写入RIF,网桥根据RIF将数据帧发送给目标地址.(即使发生环路,目标地址也只会接收第一个到来的数据并识别对应的网桥,后续再发送过来的数据就会被丢弃.)这种方式要求发送端本身必须具有源路由的功能.

8. VLAN:当需要分散网络负载,交换部署网络设备的位置时将原本需要改造硬件转变为通过VLAN从软件上对各个网络进行分段,从而减少网络负载并提高网络安全性(交换机进行广播时只需要在某些网段内广播即可,减少了广播的范围).(但异构的网段之间需要通过路由器建立连接从而实现通信.)

#### 以太网

1. 以太网就是一种数据链路.

2. 以太网连接方式:从共享介质型到现在的非共享介质型(终端和交换机用一根电缆线相连).

3. 以太网的分类:根据传输速度和传输所用介质进行分类.传输速度相同但传输所用介质不同可以用中继器或集线器.传输速度不同就必须用网桥,交换机或路由器. 注意:以太网中衡量速度的是时钟频率,换算单位是1000不是1024.

4.  ![1651586419293](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1651586419293.png)

   帧长度:以太网数据帧的长度.

   SNAP:记录了上一层网络层中协议的类型

   FCS:用以检验数据在传输过程中是否发生损坏.(基于CRC(循环冗余算法))整个帧除以生成多项式的余数).该字段可以检测出大量突发错误.

#### 无线通信

1. 无线路由器和有线路由器的区别:
   1. 无线路由器可以通过无线(WiFi)信号和手机和电脑建立连接;有线路由器必须通过网线和电脑连接才能上网,手机不能直接通过有线路由器上网.
   2. 无线路由器可以连接更多的设备;有线路由器连接的设备数少
   3. 无线路由器相较于有线路由器速度更慢.因此家用的一般都是无线路由器,工业用的一般都是有线路由器.
2. 终端设备连上网的流程:首先光猫将光信号转为电信号,然后通过和无线路由器相连将有线网络信号转为无线(WiFi)和终端设备相连.
3. 无线通信的种类:
   1. 无线PAN:10m左右的通信距离    典型技术:蓝牙
   2. 无线LAN:100m左右的通信距离  典型技术:WiFi
   3. 无线MAN:数千米左右的通信距离  典型技术:WiMAX(无线城域网)
   4. 无线WAN:------------    典型技术:3G,4G,下一代通信网络

#### PPP

1. 定义:点对点,即1对1连接计算机的协议.PPP只属于数据链路层,与以太网不同,以太网既与数据链路层有关也与物理层有关.

#### 公共网络

1. 模拟电话线路:利用固定电话线路进行通信,电话线中的音频带宽用于拨号上网.让计算机与电话线相连需要有一个将数字信号转化为模拟信号的调制解调器(光猫)
2. ADSL:对已有的模拟电话线路进行拓展的一种服务.在电话机到电信局交换机之间的这段线路上附加一个叫做分离器的装置,将音频信号(低频信号)和数字信号(高频信号)隔离以免产生噪声干扰.
3. FTTH:通过一根高速光纤直接连到用户家中.FTTH可以实现高速的网络通信.



## IP协议

#### 网际协议

1. IP即OSI模型中的第3层网络层.网络层的作用是实现终端之间的网络通信.对于数据链路层而言,其作用是实现同一种数据链路节点间的包传递.当跨越多种数据链路时需要用到网络层. IP的主要作用就是在复杂的网络环境中将数据报传递给目的地址.
2. 节点,路由器,主机之间的区别
   1. 节点:节点是主机和路由器的统称.
   2. 路由器:既具有IP地址,也具有路由控制功能的设备
   3. 主机:只具有IP地址,不具有路由控制功能的设备
3. 网络层和数据链路层之间的关系:网络层和数据链路层之间的关系就相当于行程表和车票之间的关系.对于车票而言,其有多种,例如火车票,机票,公交车票等等.某种车票只能负责在某一个区间内进行传递.而数据链路层也是如此,只能在某一段内负责通信传输;行程表则通过出发地和目的地来选取一条合适的线路.   如果只有网络层,没有数据链路层,则只知道如何走,而不能真正的把数据传递给目的地;如果只有数据链路层,没有网络层,对于复杂的网络而言,当数据链路的种类发生变化时,无法得知具体往哪个方向走,也就是说不知道如何"换乘".所以在计算机网络中,数据链路层和网络层二者缺一不可.

#### IP基础知识

1. IP的三个作用:IP寻址,路由控制以及IP分包与组包.
2. IP地址用来在**连接到网络中的所有设备中**找到进行通信的目标地址,MAC地址在**同一个数据链路中**识别某一个.计算机.一台主机的IP地址不会因为数据链路的不同而改变(MAC地址则不一定).
3. 路由控制:在复杂的网络中将分组数据包发送到目标地址的功能.IP包也就多跳路由,
   1. 路由控制的实现过程:"跳"是指一个区间(这个区间就是数据链路层中从源MAC地址到目的MAC地址的一个区间).在每一个区间都决定着包在下一跳被转发的路径.多跳路由是指某个主机或路由器在转发IP数据包时只是将其转发到下一个路由器或者主机中,而不是最终的目的地址.因为每一跳在转发IP包时都会指定下一跳的操作,所以最终会送到目标地址.整个路由控制的过程就相当于顾客坐地铁去A地旅游:当顾客到达某一号线时会询问该线的服务人员A怎么走,服务人员(主机或路由器)会告诉你接下来该乘坐哪一号线(下一个路由器或主机),然后后续的路程可以等到到下一个地方时问附近的服务人员,直到最终到达目标地址.
   2. 路由控制表:为了将数据包发送到目标地址,每个主机(或路由器)都会维护一张路由控制表,该表中记录了某个IP数据包在下一步应该发送到那个主机(或路由器)和其对应的网络的映射关系.当一个目标地址在某一个路由器上的路由控制表上有多条对应记录时,选取最为吻合的网络地址(最吻合指与目标地址相同位数最多的路由器(主机)地址)
4. 数据链路的抽象化:数据链路有很多种,IP的一个重要作用就是对这些不同的数据链路的相异特性进行抽象化.对于不同的数据链路而言,其最大的特点就是一次可以发送的数据的最大范围(MTU)不同,IP数据的分包更多的是因为数据链路层中不同的MTU的限制.这种抽象的好处是对于IP的上一层而言,其不需要考虑针对不同的MTU对数据进行分片处理,而是只需要将源地址发送的数据长度接收.
5. IP属于面向无连接型.面向无连接的好处:简化 + 提速.而可靠性则是依赖上一层的TCP.

#### IP地址的基础知识

1. 定义:IP地址由32位整数组成.在计算机内部是以二进制的形式被处理,但在现实世界中则是以点分十进制的形式表示.
2. IP地址是根据网卡进行设置的,而不是根据计算机进行设置的.一个网卡(NIC)上一般只有1个IP地址.路由器上通常有2个以上的IP地址.
3. IP地址由网络标识和主机标识两部分组成.
4. 广播和多播的区别
   1. 广播的数据在网络中的每一台主机都可以接收到,对于那些不想接收信息的主机,需要在传输层进行拒收;多播是一对一组,将一台主机发送的数据传递给特定组内的每一太主机.
   2. 多播是直接基于IP协议进行发送数据的,速度快,但是不可靠.

#### 子网掩码

1. 在子网掩码诞生之前,1个IP地址根据分类被分成ABCD四类,不同类型的IP地址属于不同的类.但随着网络结构的多样化,单一的被分成4类有时会造成资源的浪费.因此子网掩码产生.
2. 通过子网掩码,IP地址可以被划分成更小粒度的网络.子网掩码中对应IP地址的网络标识部分全为1,主机标识部分全为0.
3. 私有地址和全局地址
   1. 私有地址:同一个局域网内的地址.以10开头,172.16-172.31,192.168开头的都是私有地址(内网IP)
   2. 全局地址:在互联网上唯一识别一个通信设备的IP地址.

#### IP分割处理与再构成处理

1. IP报文的分片与重组:IP的分片功能主机和路由器都具有,IP的组包功能只有目的主机具有.这是因为IP报文从原主机到目的主机的传输过程中,经历了很多路由器的转运.因为不同数据链路的MTU不同,所以不同的路由器对IP报文的分片的格式是不同的;因为分片的IP包不一定会完整的传输到目的主机,所以为了提高路由器的效率,只让目的主机具有组包的功能.
2. IP分片大部分是按照某个数据链路的最大MTU来进行分片.路由器对IP包进行分片降低了路由器的效率.尤其是路由器需要承担的功能越来越多.同时在分片的过程中一旦某个分片丢失,整个IP数据报报废也严重影响了传输效率.因此MTU路径发现的技术产生.
3. 路径MTU发现:源主机在发送IP数据报给目的主机时,按照传输过程中数据链路的最小MTU进行分包发送,不再需要路由器进行分片.
4. 路径MTU发现的工作原理:
   1. UDP:首先发送方发送IP数据报是将IP首部的禁止分片的字段设置为1.根据这个标识,路由器即使遇到较大的包时也不会分片,而是直接丢弃.随后ICMP会将丢弃对应的数据链路的MTU值返回给发送方,发送方会根据得到的MTU进行分包处理,然后继续发送,如此反复.直到不再接收ICMP.此时发送方会认为正常发送时对应的MTU即为一个合适的MTU,当MTU的值比较多时,会在短时间内使用这个MTU,之后会重新做一次路径MTU发现
   2. TCP:根据路径MTU的大小计算出最大段长度(MSS),然后根据这些信息进行数据报的发送.在TCP中,IP不再对数据报进行分片,而是直接有TCP层直接分好.

#### IPV6

1. IPV6的出现是为了解决IPV4提供的IP地址不够用的问题.IPV6的地址长度是16个字节.由冒号分十六进制表示.
2. IPV6实现的功能:
   1. IP地址的扩大与路由控制表的聚合:IP地址依然适应互联网分层构造,分配与其地址结构相适应的IP地址.尽可能避免路由表扩大.
   2. 性能提升:包首部长度采用固定的40字节,不再采用首部检验码,简化首部结构,减轻路由器负担,路由器不再做分片处理.
   3. 支持即插即用的功能:即使没有DHCP服务器也可以实现自动分配IP地址.
   4. 采用认证与加密功能:应对伪造IP地址的网络安全功能以及防止线路窃听的功能(IPsec)
   5. 多播,MobileIP成为拓展功能

#### IPV4首部



![1652235622715](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1652235622715.png)

1. 版本:由4个比特组成.IPV4的版本就是4.IPV4的下一个版本是IPV6,之所以是IPv6而不是其他的版本是因为IPV6是在众多为了改善IPV4的协议群中脱颖而出的一个协议.实际上版本号并没有太大的意义.
2. IP首部的长度,为4比特.当没有选项可选时,IP首部长度设置为5.即(5*4=20个比特)
3. 服务类型(区分服务):包括优先度(0 1 2),最低延迟(3),最大吞吐(4),最大可靠性(5),最小代价(6),最大安全(3-6),未定义(7).这个值通常由应用决定.但因为按照发送本身的功能实现非常困难,TOS在互联网中几乎没有被使用.一种思路是将TOS字段设置为DSCP,ECN两个字段.
   1. DSCP:差分服务代码点,现在也叫DiffServ,是TOS的一部分.用来进行质量控制.共占据TOS的前0-5个位置.当3-5位的值为0,0-2位则被称作类别选择代码点.(提供8种类型的质量控级别).
   2. ECN:显示拥塞通告.用来报告网络拥堵情况,由2个字节组成.**第6位的ECT用来通告上层TCP协议是否处理ECN**,路由器转发ECN为1的包的过程中,**如果网络出现拥堵,则第7位的CE被设置为1**.
4. 总长度:由16位组成.表示IP包的最大程度为64k
5. 标识(ID):由16个比特组成,用于分片重组,同一个分片的标识值相同.
6. 标志(Flags):由3个比特组成.0位未使用,值为0;1位为0表示可以分片,为1表示禁止分片;2位为0表示最后一个分片的包,为1表示该分片后续还有包.
7. 片偏移:由13个比特组成,表示一个分片中的某个片段相对于原始数据的位置.第一个分片的值为0.
8. 生存时间:由8个比特组成.每经过1个路由器,TTL的值－1.
9. 协议:由8个比特组成.表示IP包传输层的上层协议编号.
10. 首部校验和:只检验IP数据报的首部的部分是否被损坏.
11. 选项:由可选项和填充两部分组成
    1. 可选项:长度可变.通常只在实验或诊断错误中使用.包含4个信息:安全级别,源路径,路径记录,时间戳
    2. 填充:在有可选项的情况下,首部的长度可能不是32位比特的整数倍,为此向该字段填充0使首部的长度保持为32位比特的整数倍.

#### IPV6首部格式

![1652239141769](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1652239141769.png)

1. 版本号:和IPV4的一样,值变成了'6'
2. 通信量类:相当于IPV4中的TOS
3. 流标号:用于服务质量(QoS)控制.
4. 有效载荷长度:是指包的数据部分.只包括数据,不包括首部.
5. 下一个首部:相当于IPV4中的"协议"
6. 跳数限制:相当于IPV4中的TTL
7. IPV6扩展首部:一些扩展的功能.

### IP协议相关技术

#### DNS(应用层协议)

1. DNS的产生背景:**IP地址不便记忆**.我们知道,在互联网通信中,每台主机都被赋予了一个唯一的IP地址.当我们想要和对方进行数据通信时,就需要指定对方主机的IP地址.而IP地址是比较难以记忆的.为此,TCP/IP在一开始就已经有了主机识别码,为每台主机赋予一个唯一的主机名,在进行网络通信时直接使用主机名,系统会自动将主机名转换为对应的IP地址.为了实现这样一个功能,主机往往会存在一个hosts文件(位于C/Windows/System32/drivers/hosts中).**随着网络规模的不断扩大,用hosts文件来处理主机名和IP地址的映射的可行性越来越低**,因此,DNS系统产生.
2. DNS系统中维护了一个用来表示组织内部主机名和IP地址之间的对应关系的数据库(当然,DNS系统中不单单只维护了主机名到IP地址的映射,还有其他很多重要信息.).在应用中,当用户输入主机名(域名)时,DNS会自动检索注册了该主机名和IP地址的数据库,并迅速定位对应的IP地址.同时,主机名和IP地址的变更也是在DNS系统内部进行处理.
3. 域名
   1. 定义:为了识别主机名称和组织机构名称的一种具有分层的名称.如:tiangong.edu.cn,从前往后分别表示:天津工业大学(tiangong),教育机构(edu),中国(cn)
   2. 域名服务器:管理域名的主机和响应的软件.各个域的分层上都有设置各自的域名服务器.**各层域名服务器都了解该层以下分层中所有域名服务器的IP地址**.**由于所有域名服务器都了解根域名服务器的IP地址**,所以从根开始顺序准总可以访问世界上所有域名服务器的地址.当某一层域往下没有分层,则该层域可以自由的连接主机名称或子网名称.在实际通信过程中,当某层的域名服务器宕机后,针对该域的DNS查询就无法正常运行.因此为了提高容灾能力,一个域会设置两到三个域名服务器,当其中一个宕机后,其上的DNS查询就会自动转移到另外几台域名服务器上.
4. 解析器:进行DNS查询的主机或软件叫做DNS解析器.个人电脑就属于解析器.
5. DNS查询
   1. 解析器为了得到访问的域名对应的IP地址,会向自己所在域的域名服务器A发送请求进行查询处理.A首先会在自己的数据库中进行查找,如果找到访问域名对应的IP地址直接返回,如果真没有,则域名服务器再向上一层根域名服务器进行查询处理,根域名服务器按照树形结构的顺序进行遍历,找到指定的域名服务器后,通过该域名服务器返回相对应的IP地址.解析器和域名服务器会将最新得到的消息暂存到缓存中,减少查询性能的消耗.

#### ARP

1. ARP的背景:用户输入域名通过DNS查询得到了访问域名对应的IP地址,于是我们可以向该目标地址发送数据报,但在底层数据链路层进行实际传输的过程中,则需要了解每个IP地址对应的MAC地址. **ARP是一种解决地址问题的协议.以目标IP地址为线索,用来定位下一个应该接收该数据报的设备对应的MAC地址.**

2. ARP的工作机制:查找同一条链路上目的主机或下一跳路由器的MAC地址

   主机A起初通过广播向同一个链路上的其他设备发送一个ARP请求包,这个包中已经包含了目的IP地址.接收到该请求包的主机或路由器会和自己的IP地址进行相对应,如果相等,则将自己的MAC地址塞入ARP响应包中返回给主机A.

    通过ARP可以动态的进行地址解析,因此我们在进行网络通信的时候无须知道对方的MAC地址,只需要知道对方的IP地址即可.

   为了避免每进行一次网络通信就进行一次ARP寻址,设备会将获取到的MAC地址缓存一段时间.存储IP地址和MAC地址对应关系的数据库叫做ARP表.在未进行下一次ARP时,可以通过查询ARP表获取目的IP地址对应的MAC地址;当进行下一次ARP时,ARP表中的内容会被清空.但这种存储是是有一定期限的,当超过这个期限,ARP表中的内容也会被清除(避免某个已记录的对应关系发生了改变而导致无法正常通信).

3. IP地址和MAC地址缺一不可:

   1. 只有IP地址:在复杂的网络结构中,我们从源主机发送信息给目的主机时需要经过各种路由器的中转,也就是要经过不同的数据链路进行传输.如果只有MAC地址,我们就无法知道下一跳路由器设备的MAC地址,也就无法继续发送数据.
   2. 只有MAC地址:我们知道MAC地址是没有分层的.也就是说只用MAC地址进行数据的传输我们无法确认一台主机的位置(IP地址通过网络标识可以确定一个地址所在的区域).因此就无法划分具体的网络.因此将会造成巨大的网络流量.同时因为没有网络的集约机制,路由器中的路由控制表,网桥中缓存的MAC地址的表的大小将会剧增.从而导致网络传输效率的下降.

4. RARP:与ARP相反,是通过MAC地址定位IP地址的一种协议.一些没有输入接口的嵌入式设备无法获取到自身的IP地址.这些设备在通电后,会向RARP服务器发送一条请求得到自身MAC地址对应的IP地址的请求,RARP服务器在接收请求后会返回该设备MAC地址对应的IP地址的响应.

5. 代理ARP:通常ARP包会被路由器隔离(防止数据的重复发送).但如果源主机和目的主机处于同一网段的不同物理网络时,就需要路由器进行代理ARP

#### ICMP

1. ICMP的主要功能包括:确认IP包是否成功发送到目标地址;通知在发送过程中IP包被废弃的具体原因,改善网络设置等.
2. ICMP的实现流程:在网络通信中,当主机A向主机B发送了数据包,由于某种原因,数据包在中间传输过程中的路由器2上被丢弃.这时路由器2就会使用IP向主机A发送一个ICMP包.收到ICMP包的主机A会分解ICMP包的首部和数据域从而得知发送失败的具体原因.
3. ICMP发送的消息的类型
   1. 通知出错原因的错误信息
   2. 用于诊断的查询信息
4. 主要的ICMP信息:
   1. ICMP目标不可达信息:当某个路由器无法将IP数据包发送给目标地址时,会给发送方返回一个目标不可达的ICMP信息,并在这个消息中显示不可达的具体原因.常见的原因有错误代码1:主机不可达(Host Unreached),指路由表中没有目标主机的信息或者该主机没有连接到网路;错误代码4:Fragment Needed and Don't Fragment was Set),指的是当前IP分片的分包大小大于下一跳中数据链路中MTU的大小而无法继续发送(用于MTU路径发现).
   2. ICMP重定向消息:如果路由器发现发送端主机使用了次优的路径发送数据,那么会返回一个ICMP重定向多的消息给发送端主机,在这个消息中包括了最合适的路由信息和源数据.
   3. ICMP超时信息:当到达某个路由器时TTL被减为0时,该路由器会向发送端主机发送一个ICMP超时信息.
   4. ICMP回送消息:用于进行通信的主机或路由器之间,判断所发送的数据是否成功到达对端的一种消息.可以向接收端发送ICMP Echo Request消息(请求对端发送回送消息)并接收对端发送的 ICMP Echo Reply消息.
5. ICMPv6:ICMP作为IP的一种辅助作用仅支持IPV4,且在IPV4中没有ICMP,IP也能正常作用.但在IPV6中,没有ICMPv6,IPV6就无法正常通信.

#### DHCP

1. DHCP产生的背景:在DHCP产生之前,设备在从一个网路移动到另一个网络后,需要手动设置IP地址.这会导致非常麻烦.为了实现自动设置IP地址,同一管理IP地址分配,就产生了DHCP.DHCP实现了即插即用(只要物理上连通,无须设置其他就可以直接使用这个物理设备).

2. DHCP的工作机制:首先DHCP客户端向DHCP服务器发送DHCP发送包(请求设置IP地址和子网掩码);DHCP服务器接收到发送包以后向DHCP客户端返回一个DHCP提供包(通知可使用的网络设置);DHCP客户端发送DHCP请求包(请求设置某个具体的设备的网络配置);DHCP服务器反馈一个DHCP提供包(允许DHCP客户端进行设置).这个情况就类似于TCP中的建立连接,然后开始通信.

   为了防止某台DHCP服务器的宕机导致整个网段的设备无法进行通信,一般会设置多台DHCP服务器,每个服务器上管理着不同的IP地址.

   为了保证所分配的IP地址时可用的.DHCP客户端和DHCP服务器需要有一下功能

   + DHCP服务器:在分配IP地址前发送一个ICMP包,确认没有应答(保证分配的IP地址可用)
   + DHCP客户端:在给某个设备分配具体的IP地址前发送一个ARP包,确认没有应答(保证该网段中该IP地址还没有被使用过)

3. DHCP中继代理:在家庭中,DHCP服务器有宽带路由器扮演;但在一些企业或者学校中,有多个不同的网段,如果每个网段内的路由器扮演DHCP服务器的角色,在后续的维护和更新中是一个巨大的任务量.因此利用DHCP中继器将不同网段连接起来,由一个DHCP服务器来分配具体的网络配置(就好比给森林加一个根节点,遍历的时候根据根节点内进行树形结构的遍历要比遍历原来森林中的每一个树要方便很多) 

#### NAT

1. NAT是用于在本地网络中使用私有地址,在连接互联网时转而使用全局IP地址的技术.NAT是转换IP地址,同样转换TCP,UDP端口号的技术叫做NAPT. NAT技术是为了解决IPV4中IP地址不够用的问题.

2. NAT的工作流程:当主机A在局域网内通信时,使用的是私有IP地址(即只在该局域网内保证唯一),当连接上互联网与其他区域进行通信时,主机A的私有IP地址首先会发送到NAT路由器中将私有IP地址转换为全局IP地址,然后再和目的端进行通信.当局域网内同时存在多台设备进行网络通信时,仅转换IP地址可能会造成全局IP地址不够用的情况,NAPT可以解决这个问题,即将源主机的端口号也进行转换.而当两台不同设备上的应用的端口号一致时,NAPT路由器上的转换表就会自动把1个设备的端口号改成改成另外一个端口号以作区分.

3. NAT-PT:将IPv6的首部转换为IPv4首部的一种技术.

4. NAT潜在问题

   1. 无法从NAT的外部向内部服务器建立连接.
   2. 转换表的生成与操作转换表会产生一定的开销
   3. 通信过程中NAT设备宕机,所有TCP连接都会被重置.

5. 解决外网访问NAT内部设备:NAT穿透(内网穿透):借助公有服务器建立连接.

   1. 主机A在NAT设备内,主机B在NAT设备外

      主机A直接向主机B发送数据(可以成功)

      主机B直接向主机A发送数据,×.此时需要借助一个公有的服务器辅助进行内网穿透.主机A和主机B向服务器发起登录请求,并保持一个TCP或UDP的连接.服务器分别记录A和B的地址和端口号.之后当B向A发送数据时,先向服务器建立连接请求,服务器收到请求会向A发送打洞命令,NAT A上会打一个方向为(主机B的地址和端口号)的洞.然后B就可以主动和A建立连接.

   2. 主机A和B都在NAT设备内.

      主机A直接向主机B发送数据(不成功)

      主机A向服务器发送请求,服务器将主机A的地址和端口号发送给主机B并发出打洞命令.主机B接收到命令后会在NAT B设备上打一个方向为(主机A的地址和端口号的洞).此时主机A向主机B发送数据

      主机B直接向主机A发送数据(不成功)

      和上述类似.

#### IP隧道

1. 由来:当两个使用IPv6网络的之间架着一个使用IPv4的网络时,这两个网络不能够直接通信.为了实现正常的通信,会在IPv6的首部前加一个IPv4的首部,进而实现正常转发.

#### 其他IP相关技术

1. IP任播

   1. 定义:为那些提供同一种服务的服务器分配同一个IP地址,并于最近的服务器进行通信的一种方法.原理和110和119电话系统相似.常见的应用有DNS根域名服务器.
   2. 限制:IP任播不能保证向同一台主机连续进行多次通信. 

2. 通信质量控制

   我们知道IP协议属于一种"尽力服务"型协议,它并不能保证通信的质量.

   1. 通信线路上的拥塞也叫收敛.当网络发生收敛时,路由器和交换机上的等待队列会溢出,从而造成大量丢包现象的发生.
   2. 通信质量控制的机制:RSVP技术.相当于在高速公路上开通了VIP通道,路由器在内部的队列中优先处理有通信质量要求的包.
      1. IntServ:点对点的详细优先控制.针对特定应用之间的通信进行质量控制.在通信时,接收端会向发送端以及路径上的所有中转设备上进行有质量控制的设定.路由器就根据这些设置进行质量控制.但由于IntServer是针对到点的,所以每次通信都会进行质量控制的设置,效率是比较低的.
      2. DiffServ:粒度相对粗的优先控制.针对特定的网络进行较粗粒度的通信质量控制.进行DiffServ质量控制的网络叫做DiffServ域.在**该域中路由器会非所有进入该域IP包首部中的TOS中的优先度字段进行设置**.根据每个包的优先度进行质量控制.

3. 显示拥塞通知(ECN:IPV4首部TOS字段和ECN字段公用)

   在TCP层也有拥塞控制机制,但该机制是在数据包发生损坏之后进行通知的.为了在数据包损坏之前来通知发送端当前网络状态比较差,降低发送速率时,引出了ECN.

   为了试下显示拥塞通知,ECN将IP首部中的TOS字段设置为了ECN字段.当网络拥塞时,会在数据包的首部设定ECN的字段来通知发送端主机.

   **拥塞检查是在网络层,拥塞通知是在TCP层**

4. Mobile IP

   普通的私有IP地址在从一个子网切换到另一个子网后IP地址会发生改变.在移动的过程中,当IP地址发生改变,诸如TCP等需要建立连接的通信就会断开.为了解决这个问题,引入Mobile IP.

   Mobile IP就像你的邻居.你搬家后,寄往你原住址的快递通过你邻居转交给你.Mobile IP就是在你的IP地址注册的位置和外地之间建立IP隧道.当你的IP地址发生改变时,通信就会经由注册位置的转发保证连接不会断开.

### TCP/UDP

#### UDP

1. UDP不提供复杂的控制机制,利用IP提供面向无连接的通信服务.当上层数据报传到UDP时,不经过任何处理直接发送.因此使用UDP需要用户在上层应用协议中规范好数据发送的标准.因此,UDP是按照"制作程序的那些用户的指示行事".
2. UDP的特点
   1. 面向数据报
   2. 不可靠
   3. 无连接
   4. 全双工
3. 基于UDP的应用层协议:包个数少,及时性要求高,可靠性低的场景.
   1. 包总量较少的通信:DNS,SNMP等
   2. 视频,音频等多媒体通信(即时通信)
   3. 广播通信(广播,多播)

#### TCP

1. TCP与UDP不同,是一种对"传输,发送,通信"进行"控制"的协议.TCP可以实现高可靠性的通信.

2. TCP的特点

   1. 有连接:"连接"是指各种设备,线路,或网络中进行通信我的两个应用程序为了相互传递信息而专有的,虚拟的通信线路,也叫作虚拟电路.
   2. 可靠
   3. 面向字节流
   4. 全双工

3. TCP关于可靠性和效率的机制.

   **可靠性?**:指接收端接收到的数据和发送端发送的数据是完全一致的,没有经历丢包,乱序,冗余等现象.TCP的提高可靠性的机制只是为了应对"非恶意行为"造成的数据段的异常,比如网络收敛导致的丢包,网络波动导致的乱序等等.但对于第三方的恶意抓取篡改等恶意行为是不能避免的,比如说第三方对某个数据包进行抓包并修改其中的内容,因为TCP是以段为单位发送的,所以接收方并不能知晓发送方应用中发送的一个消息的大小,所以第三方可以对其中的内容进行修改而不被接收方发觉(检验和这种方式并不能完全避免这种行为),一种比较好的做法是对发送的数据段进行加密操作.

   1. 通过序列号与确认应答提高可靠性.

      在TCP中,当发送端的数据到达接收端时,接收端会返回一个"已收到消息"的通知,这个消息叫做确认应答(ACK).

      确认应答机制相当于两个人进行谈话.在谈话的过程中,当一个人说明自己的观点后会根据对方的"反馈"(比如: "嗯.",  "咦?")来告知自己应该再重复一遍自己的观点还是继续接下来的谈话.

      **TCP通过ACK来实现可靠的数据传输**,发送端在发送数据之后会等待接收端的确认应答,如果有确认应答,说明数据已经成功到达对端,否则说明数据丢失的可能性非常大.

      当接收端在一段时间内没有接收到ACK后会将之前发送的数据重传一次.这种没有接收到ACK如果是由于接收端已经接收到数据,在发送ACK时因为网络收敛而导致发送端没有正常接收到时,接收端就会接收到重复的数据,为了处理重复数据以及更好的进行确认应答,引入了"**序列号**"

      序列号是按顺序给发送数据的每一个字节都标上号的标号(初始编号在建立连接时由随机数生成).

   2. 重发超时如何确定

      重发超时是指在重复数据之前,发送端等待确认应答到达的时间间隔,一旦超过这个时间间隔,发送端就会重传数据.这个重发超时的具体时间**既要保证高性能传输,也要保证确认应答一定能在这个时间段内到达发送端**.为此,TCP在每次发包是都会计算**往返时间(RTT)和偏差**,重发超时的时间比RTT和偏差的和大一点.

      在Windows中,超时重传的时间是0.5s的整数倍.当重传数据之后仍没有接收到ACK,重传的时间会以2的幂的倍数增长.初次重传由于不知道RTT,所以一般设置为6s左右.当重传多次后,如果仍然没有收到ACK,则强制关闭连接,并通知应用程序通信异常终止.

   3. 连接管理

      TCP为了保证通信的可靠性,在数据传输之前会建立连接(三次挥手),在通信结束后会关闭连接(四次握手)

      建立连接:

       	1. 发送端-----(SYN)------->接收端
       	2. 接收端-----(ACK,SYN)----->发送端
       	3. 发送端 --------(ACK)-------->接收端

      断开连接

      1. 发送端(也可以是接收端)--------(FIN)---->接收端
      2. 接收端-----------(ACK)------------>发送端
      3. 接收端------------(FIN)------------>发送端
      4. 发送端------------(ACK)------------->接收端

   4. TCP以段为单位发送数据

      TCP在发送数据时每个数据包的最大大小为"MSS"(最大消息长度-Maximum Segment Size).理想情况下,MSS的大小等于IP中不会被分片处理的最大数据长度.

      MSS是TCP在三次握手中发送端和接收端将各自的MSS大小写入TCP首部,然后并取二者中的较小值.

   5. 利用滑动窗口提升速度

   6. 窗口控制与重传控制

   7. 延迟应答与捎带应答

#### 其他传输层协议

1. UDP-Lite(轻量级用户数据报协议),是扩展UDP机能的一种传输层协议.在基于UDP通信中,如果校验和出现错误,整个UDP数据报会被丢弃,而若将校验和设置为无效,则UDP包无论如何也不会被丢弃.在某些应用中,这样的处理方式明显是不妥的,因此**UDP-Lite允许应用自行决定校验的范围.可以只针对数据报中必须保证正确的部分进行校验.**

2. SCTP(流控制传输协议):与TCP提供的服务类似.主要特点

   1. **以消息为单位收发数据**(跟UDP一样),这种较小的消息也叫作数据块
   2. **支持多重宿主**:一台设备上可能有多个NIC,对于TCP而言,在传输过程中端的IP地址是不能发生改变的,否则会断开连接.而SCTP只要有一个NIC在正常传输就不会断开连接
   3. **有效防止了DOS攻击(拒绝服务)**.TCP中建立连接时接收端会将发送端发来的SYN报缓存下来.黑客借此可以伪造大量SYN包导致接收端缓冲区被占满,进而无法通信.SCTP通过四次握手建立连接,在接收方接收到SYN报时不会立即缓存而会向发送端发送一个Cookie的报文,当发送端反馈一个相应的Cookie报文后才会缓存SYN包.
   4. 支持多数据流通信:TCP中需要建立多个连接进行通信,SCTP中只需要建立一个.
   5. **可以定义消息的生存期限**:超过生存期限则不会重发.

   DCCP(数据报拥塞控制协议):辅助UDP建立拥塞控制机制的协议.是**一种面向连接但不可靠的传输层协议**

#### UDP首部格式

![1653046766265](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1653046766265.png)

其中检验和是为了提供可靠的UDP首部和数据而设计.计算校验和时,通过在伪首部和UDP数据包之间进行补0使UDP数据报的长度为16比特的整数倍.将UDP校验和字段设为全0,然后以16位单位进行1的补码和,并将结果写入校验和中,接收方接收到UDP数据报时,再进行校验和计算,当所有数据的结果为全1时,认为该数据是正确的.![1653048020651](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1653048020651.png)

UDP伪首部的存在是因为在进行网络通信时最基础的五元组是:源IP地址,源端口号,目的IP地址,目的端口号,协议号.对于UDP首部,只存在源端口号和目的端口号,所以为了保证这5项均不被破坏,要引出UDP伪首部

#### TCP首部格式

![1653048217115](C:\Users\qiu\AppData\Roaming\Typora\typora-user-images\1653048217115.png)

相关含义可以参考[UDP协议和TCP协议](https://blog.csdn.net/weixin_52477733/article/details/124537412?spm=1001.2014.3001.5502)

在TCP中,一个连接建立之后最大的吞吐量是有限制的,因此,为了提高吞吐量,在进行网络通信时,一般会建立多个连接同时通信.

### 路由协议

1. 路由种类

   1. 静态路由:在进行网络通信之前,由管理者手动在路由器上设置路由控制表.  静态路由的缺点就是给管理员带来很大的负担,而且一旦某个路由器发生故障,数据包不能绕过该路由器继续传输.
   2. 动态路由:由管理员设置路由协议,路由器会自动将自身的信息传递给相邻的路由器,经过整个网络的传输,路由器可以得到网络中各个设备的相应信息.

2. 路由控制范围

   1. IGP:内部网关协议,负责在区域网络内部进行主机识别,IGP中还可以使用RIP,RIP2,OSPF
   2. EGP:外部网关协议,负责在区域网络之间进行路由选择.EGP使用的是BGP
   3. IGP与EGP的关系就相当于IP地址的网络部分和主机部分.

3. 路由算法

   1. 距离向量算法:路由控制表中记录的是某个路由器到某个网络的最近距离.这个距离指的是经过的路由器的个数,也叫"跳数".信息比较简单且每个路由器和每个路由器上路由控制表中的信息均不同,无法验证哪个是正确的,也无法解决死循环的问题.
   2. 链路状态算法:在了解整个网络连接状态的基础上建立路由控制表.由此得到的路由控制表中的信息是一致的,可以验证是否正确,也可以解决死循环的问题.缺点就是生成路由控制表的代价很大.

4. RIP:基于距离向量的一种路由协议,广泛用于LAN. RIP会定时向全网广播路由控制信息.

   1. RIF中路由变更时的处理

      1. 定时向全网广播路由控制信息
      2. 一旦认为网络断开,数据将无法经过此路由器进行传输.

      存在的问题:当路由器A向全网广播自己的信息后,自己与网络A的连接断开,于是路由器A得出网络A中的信息不能传输给路由器B.  路由器B接收到路由器A的信息后会将自身的信息一起再发送给路由器A(还有其他相邻路由器),此时路由器A接收到路由器B的消息,于是路由器A"认为"自己可以\通过路由器B将信息发送给网络A.但其实网络A已经与路由器A断开,不能再向网络A中传输信息了.这一问题被称为无线计数.

      ​	解决方法:

       	1. 最长距离不超过16
       	2. 水平分割:规定路由器不把所收到的信息原路返还给发送端.

      无法解决网络本身存在环路的情况.

      ​	解决方法:

      1. 毒性逆转:当网络中某个链路断开后,向该链路无法进行通信的消息传播出去(即发送一个距离为16的消息).
      2. 触发更新:当路由信息发生变化时,迅速发送一个路由信息发生变化的信息.

      然而在更复杂的网络环境中,上述解决方法的代价是非常大的,所以我们需要在了解整个网络状态,由此引出OSPF.

5. OSPF:基于链路状态的一种路由协议

### 应用层协议

1. 远程登录:TELNET

   1. 提供的服务:仿真终端,协商选项
   2. TELNET经常用于登录路由器或者高性能交换机等网络设备进行相应的设置.

2. SSH:加密的远程登录

   1. 功能:可以使用更强认证机制;可以转发文件;可以使用端口转发功能:将特定端口号接收到的程序发送给指定IP地址和端口号.能够确保发送的信息的安全.

3. FTP:文件传输.FTP是基于两次TCP连接进行文件传输的,其中一个TCP连接用于控制(登录,验证等等),另一个TCP连接用于发送数据.且两个TCP连接的方向是相反的.

   1. PORT:主动模式.客户端向服务端发送连接请求,服务器接受连接,构成一个线路.客户端用POST命令告知服务器打开了一个xx端口,让服务器连接该端口,建立发送数据的线路.
   2. PASV:被动模式.客户端向服务器发送连接请求,服务器接受连接,构成一个线路.服务器用PASV命令告知客户端打开了一个xx端口,让客户端连接该端口,建立发送数据的线路.

   当客户端只有私有IP时,由于NAT的单向机制(服务器无法直接向客户端发送数据),所以需要将模式改为PASV.

4. 电子邮件

   1. SMTP:基于TCP的一种提供电子邮件服务的应用层协议.

      早起邮件的发送是直接基于TCP进行的,这保障了数据传输的可靠性.但基于此,只有在两台设备都开机的情况下,邮件才能正常发送.这对于有时间差且经常开关机的用户而言无疑是一种"致命打击".为此引出了邮件服务器.发送端和接收端通过邮件服务器来收发邮件,接收端从邮件服务器中接收邮件使用的是POP3协议.

   2. 电子邮件的机制由3部分组成:邮件地址,数据格式以及发送协议.

      1. 邮件地址:  名称@通信地址.邮件的发送地址由DNS进行管理,DNS中注册有发送地址以及对应的邮件服务器的域名.
      2. 数据格式:MIME:能够发送多种数据格式的邮件.有首部的Content-Type字段决定.
      3. SMTP:发送电子邮件的应用层协议,建立一个TCP连接,在该连接上进行控制和应答以及数据的发送.
      4. POP:用于接收端接收邮件的协议.

5. 网络管理

   1. SNMP:基于UDP/IP的协议.